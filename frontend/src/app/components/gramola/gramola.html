<div class="background-layer" 
     [style.backgroundImage]="currentTrack ? 'url(' + currentTrack.album.images[0].url + ')' : 'none'">
</div>
<div class="backdrop-overlay"></div>

<div class="gramola-container">
  
  <div class="ambient-floating-bar fade-in" *ngIf="playlistFondo">
    <div class="ambient-capsule glass-effect">
      <div class="equalizer">
        <span class="bar"></span><span class="bar"></span><span class="bar"></span><span class="bar"></span>
      </div>
      <div class="ambient-text">
        <span class="label-status">EN EL AIRE â€¢ CANAL DE FONDO</span>
        <span class="pl-title">{{ playlistFondo.name }}</span>
      </div>
    </div>
  </div>

  <main class="main-content">
    
    <div class="player-wrapper fade-in">
      
      <section class="now-playing-glass" [class.is-paused]="isPaused">
        <div class="art-container">
          <img *ngIf="currentTrack" [src]="currentTrack.album.images[0].url" class="album-art">
          <div *ngIf="!currentTrack" class="album-placeholder">ğŸ’¿</div>
          <div class="vinyl-record" *ngIf="currentTrack" [class.spinning]="!isPaused"></div>
        </div>

        <div class="track-info-large">
          <div class="status-pill" *ngIf="currentTrack">
            <span class="dot" [class.animate]="!isPaused"></span>
            {{ cancionSonando ? 'Pedido por Cliente' : 'MÃºsica de Ambiente' }}
          </div>
          <h2 class="hero-title">{{ currentTrack ? currentTrack.name : 'Iniciando...' }}</h2>
          <p class="hero-artist">{{ currentTrack ? currentTrack.artists[0].name : '' }}</p>

          <div class="progress-container" *ngIf="currentTrack">
            <div class="time-labels">
              <span>{{ formatTime(progressMs) }}</span>
              <span>{{ formatTime(durationMs) }}</span>
            </div>
            <div class="progress-bar-bg">
              <div class="progress-fill" [style.width.%]="progressPercent"></div>
            </div>
          </div>
        </div>
      </section>

      <section class="search-section">
        <div class="search-glass">
          <span class="search-icon">ğŸ”</span>
          <input type="text" [(ngModel)]="busqueda" (keyup.enter)="search()" 
                 placeholder="AÃ±adir canciÃ³n a la cola..." class="search-input">
          <button (click)="search()" class="btn-search">Buscar</button>
        </div>
      </section>

      <div *ngIf="searchResults.length > 0" class="results-overlay fade-in-up">
        <div class="glass-header-results">
          <h3>Resultados</h3>
          <button class="btn-close" (click)="searchResults = []">âœ•</button>
        </div>
        <div class="results-grid">
          <div class="result-card" *ngFor="let track of searchResults" (click)="anadir(track)">
            <img [src]="track.album.images[0]?.url" class="result-img">
            <div class="result-info">
              <span class="r-title">{{ track.name }}</span>
              <span class="r-artist">{{ track.artists[0].name }}</span>
            </div>
            <div class="result-action">
              <span class="price-tag">0.50 â‚¬</span>
              <button class="btn-add">+</button>
            </div>
          </div>
        </div>
      </div>

      <div class="lists-layout">
        
        <section class="queue-section">
          <h3 class="section-title">Cola de Pedidos</h3>
          <div *ngIf="colaReproduccion.length === 0" class="empty-state-glass">
            <div class="empty-icon">ğŸ˜Œ</div>
            <p>No hay pedidos en espera.</p>
          </div>
          <div class="queue-list" *ngIf="colaReproduccion.length > 0">
            <div class="queue-card" *ngFor="let item of colaReproduccion; let i = index">
              <div class="q-index">{{ i + 1 }}</div>
              <div class="q-info">
                <span class="q-title">{{ item.titulo }}</span>
                <span class="q-artist">{{ item.artista }}</span>
              </div>
              <span class="badge-wait">En espera</span>
            </div>
          </div>
        </section>

        <section class="history-section">
          <h3 class="section-title">ReciÃ©n Sonadas</h3>
          <div class="history-list">
            <div class="history-card" *ngFor="let item of historialVisual"
                 [class.is-ambiente]="item.tipo === 'AMBIENTE'">
              <div class="h-info">
                <span class="h-title">{{ item.titulo }}</span>
                <span class="h-artist">{{ item.artista }}</span>
              </div>
              <span class="h-check" *ngIf="item.tipo === 'PEDIDO'">ğŸ’</span>
              <span class="h-check" *ngIf="item.tipo === 'AMBIENTE'">ğŸ“»</span>
            </div>
            <p *ngIf="historialVisual.length === 0" class="text-muted">Sin historial reciente.</p>
          </div>
        </section>

      </div>

    </div>
  </main>

  <app-pasarela-pago *ngIf="showPaymentModal" [isModal]="true" (close)="onPaymentClosed($event)"></app-pasarela-pago>

</div>